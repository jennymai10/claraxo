name: CI Pipeline

# Trigger the workflow on every push or pull request to the main branch
on:
  push:
    branches:
      - main
      - game/api_integration
  pull_request:
    branches:
      - main

jobs:
  backend:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code from the repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Set up Python 3.12 environment
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12'

      # Step 3: Install dependencies and activate virtual environment
      - name: Install Backend Dependencies
        run: |
          cd tictactoe_project
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Verify virtual environment is active
      - name: Verify Virtual Environment
        run: |
          cd tictactoe_project
          source venv/bin/activate
          which python
          python -m django --version
      
      # Step 5: Install Chrome and ChromeDriver
      - name: Set up ChromeDriver
        uses: nanasess/setup-chromedriver@v2.2.2

      # Step 6: Run migrations
      - name: Run Django migrations
        run: |
          cd tictactoe_project
          source venv/bin/activate
          python manage.py makemigrations
          python manage.py migrate

      # Step 7: Install frontend dependencies
      - name: Install Frontend Dependencies
        run: |
          cd tictactoe_project/tictactoe_frontend/tic-tac-toe-frontend
          npm install

      # Step 8: Start Django server in the background
      - name: Start Backend Server
        run: |
          cd tictactoe_project
          source venv/bin/activate
          nohup python manage.py runserver 0.0.0.0:8000 --noreload &
          sleep 20  # Allow the backend time to fully start
          curl http://localhost:8000/swagger/  # Verify the server is running

      # Step 9: Start Frontend Server
      - name: Start Frontend Server
        run: |
          cd tictactoe_project/tictactoe_frontend/tic-tac-toe-frontend
          nohup npm start & 
          sleep 20 # Give time for the frontend server to start
          curl http://localhost:3000  # Verify the server is running

      # Step 10: Run Selenium Tests
      - name: Run Selenium Tests
        run: |
          cd tictactoe_project
          source venv/bin/activate
          pytest

      # Step 11: Stop Servers
      - name: Stop Backend Server
        run: |
          pkill -f "python manage.py runserver"
          
      - name: Stop Frontend Server
        run: |
          pkill -f "npm start"

  frontend:
    runs-on: ubuntu-latest
    needs: backend  # Ensure frontend starts after backend tests pass

    steps:
      # Step 1: Checkout code from the repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Set up Node.js 16.x
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'

      # Step 3: Install frontend dependencies
      - name: Install Frontend Dependencies
        run: |
          cd tictactoe_project/tictactoe_frontend/tic-tac-toe-frontend
          npm install

      # Step 4: Run frontend tests
      - name: Run Frontend Tests
        run: |
          cd tictactoe_project/tictactoe_frontend/tic-tac-toe-frontend
          npm test