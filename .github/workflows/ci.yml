name: CI Pipeline

# Trigger the workflow on every push or pull request to the main branch
on:
  push:
    branches:
      - main
      - game/api_integration
  pull_request:
    branches:
      - main

# CI Pipeline YAML

jobs:
  backend:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code from the repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Set up Python 3.12 environment
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12'

      # Step 3: Install dependencies and activate virtual environment
      - name: Install Backend Dependencies
        run: |
          cd tictactoe_project
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # Step 4: Verify virtual environment is active
      - name: Verify Virtual Environment
        run: |
          cd tictactoe_project
          source venv/bin/activate
          which python
          python -m django --version
      
      # Step 4: Install Chrome and ChromeDriver
      - name: Set up ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install ./google-chrome-stable_current_amd64.deb
          wget https://chromedriver.storage.googleapis.com/114.0.5735.90/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/

      # Step 5: Run migrations
      - name: Run Django migrations
        run: |
          cd tictactoe_project
          source venv/bin/activate
          python manage.py makemigrations
          python manage.py migrate

      # Step 6: Start Django server in the background (necessary for Selenium tests)
      - name: Start Django Server (background)
        run: |
          cd tictactoe_project
          source venv/bin/activate
          nohup python manage.py runserver 0.0.0.0:8000 &
      
      # Step 7: Run Selenium tests
      - name: Run Backend Tests
        run: |
          cd tictactoe_project
          source venv/bin/activate
          pytest
      
      # Step 8: Stop Django server
      - name: Stop Django Server
        run: |
          pkill -f "python manage.py runserver"
          
  # Frontend job
  frontend:
    runs-on: ubuntu-latest
    needs: backend # This ensures the frontend job starts only if the backend job succeeds

    steps:
      # Step 1: Checkout code from the repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Set up Node.js 16.x
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'

      # Step 3: Install frontend dependencies
      - name: Install Frontend Dependencies
        run: |
          cd tictactoe_project/tictactoe_frontend/tic-tac-toe-frontend
          npm install

      # Step 4: Run frontend tests
      - name: Run Frontend Tests
        run: |
          cd tictactoe_project/tictactoe_frontend/tic-tac-toe-frontend
          npm test